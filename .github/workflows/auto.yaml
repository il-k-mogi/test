name: Automatic Branch Merging

on:
  pull_request:
    types:
      - closed
    branches:
      - 'release/v*'

# permissions:
#   contents: write
#   pull-requests: write
#   issues: write

# jobs:
#   merge:
#     name: Cascading Auto Merge
#     runs-on: ubuntu-latest

#     # PR がマージされて、マージ先が release/v から始まるブランチ
#     if: |
#       github.event.pull_request.merged == true
#       && startsWith(github.base_ref, 'release/v')
#       && github.actor != 'github-action[bot]'

#     steps:
#       - name: Automatic Merge
#         uses: ActionsDesk/cascading-downstream-merge@v3.1.0
#         with:
#           github_token: ${{ secrets.GITHUB_TOKEN }}
#           prefixes: release/v
#           ref_branch: main

# jobs:
#   cascade:
#     runs-on: ubuntu-latest
#     steps:
#       - name: Checkout
#         uses: actions/checkout@v4
#         with:
#           fetch-depth: 0

#       - name: Create PR to main and next release
#         env:
#           GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
#         run: |
#           CURRENT_BRANCH=${GITHUB_REF#refs/heads/}
          
#           # 1. mainへのマージPR作成
#           gh pr create --base main --head $CURRENT_BRANCH \
#             --title "chore: cascade merge $CURRENT_BRANCH to main" \
#             --body "Automatic cascade merge from $CURRENT_BRANCH" || echo "PR to main already exists or failed"

#           # 2. 次のリリースブランチを特定
#           # 全てのリリースブランチを取得してバージョン順にソート
#           NEXT_BRANCH=$(git branch -r | grep 'origin/release/v' | sed 's/  origin\///' | sort -V | sed -n "/^$CURRENT_BRANCH$/{n;p;}")

#           if [ -n "$NEXT_BRANCH" ]; then
#             echo "Next branch is $NEXT_BRANCH. Creating PR..."
#             gh pr create --base $NEXT_BRANCH --head $CURRENT_BRANCH \
#               --title "chore: cascade merge $CURRENT_BRANCH to $NEXT_BRANCH" \
#               --body "Automatic cascade merge from $CURRENT_BRANCH to $NEXT_BRANCH" || echo "PR to $NEXT_BRANCH already exists"
#           else
#             echo "No higher release branch found. Cascade ends here."
#           fi

jobs:
  cascade:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # すべてのブランチ情報を取得するために必要

      - name: Find next version branch and Create PR
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CURRENT_BRANCH: ${{ github.ref_name }}
        run: |
          echo "Current branch: $CURRENT_BRANCH"

          # 1. リモートの release ブランチ一覧を取得し、バージョン順にソート
          # (origin/release/ を削除してブランチ名のみにする)
          BRANCHES=$(git branch -r | grep 'origin/release/' | sed 's/origin\///' | sort -V | xargs)
          
          echo "Detected release branches: $BRANCHES"

          # 配列に変換
          IFS=' ' read -r -a BRANCH_ARRAY <<< "$BRANCHES"
          
          NEXT_BRANCH=""
          FOUND_CURRENT=false

          # 2. 現在のブランチの「次」にあるブランチを探す
          for BRANCH in "${BRANCH_ARRAY[@]}"; do
            if [ "$FOUND_CURRENT" = true ]; then
              NEXT_BRANCH="$BRANCH"
              break
            fi
            if [ "$BRANCH" = "$CURRENT_BRANCH" ]; then
              FOUND_CURRENT=true
            fi
          done

          # 3. 次のブランチが見つからなければ終了（最新バージョンの場合など）
          if [ -z "$NEXT_BRANCH" ]; then
            echo "No newer release branch found. Cascade complete."
            exit 0
          fi

          echo "Next branch to merge into: $NEXT_BRANCH"

          # 4. 既に同等のPRが存在するか確認 (二重作成防止)
          EXISTING_PR=$(gh pr list --base "$NEXT_BRANCH" --head "$CURRENT_BRANCH" --state open --json url --jq '.[0].url')
          
          if [ -n "$EXISTING_PR" ]; then
            echo "PR already exists: $EXISTING_PR"
            exit 0
          fi

          # 5. PRを作成
          echo "Creating PR from $CURRENT_BRANCH to $NEXT_BRANCH..."
          
          gh pr create \
            --base "$NEXT_BRANCH" \
            --head "$CURRENT_BRANCH" \
            --title "Cascade Merge: $CURRENT_BRANCH -> $NEXT_BRANCH" \
            --body "This is an automated cascade merge PR triggered by a push to $CURRENT_BRANCH."
# --label "cascade-merge"
